{% extends "base.html" %}

{% block title %}Dance Motion Tracker - Home{% endblock %}

{% block content %}
<div class="row">
    <!-- Upload Section -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Upload Dance Video
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="videoFile" class="form-label">Select Video File</label>
                        <input type="file" class="form-control" id="videoFile" name="video" 
                               accept=".mp4,.avi,.mov,.mkv,.webm" required>
                        <div class="form-text">
                            Supported formats: MP4, AVI, MOV, MKV, WebM (Max: 500MB)
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            Upload Video
                        </button>
                    </div>
                </form>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Uploading...</small>
                </div>
            </div>
        </div>
        
        <!-- Video Info Card -->
        <div id="videoInfoCard" class="card shadow-sm mt-4" style="display: none;">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Video Information
                </h6>
            </div>
            <div class="card-body">
                <div id="videoInfo"></div>
            </div>
        </div>
    </div>
    
    <!-- Processing Options -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Processing Options
                </h5>
            </div>
            <div class="card-body">
                <form id="processingForm">
                    <!-- Smoothing Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="applySmoothing" checked>
                            <label class="form-check-label" for="applySmoothing">
                                Apply Pose Smoothing
                            </label>
                        </div>
                        <div class="form-text">Reduces jitter in pose tracking data</div>
                    </div>
                    
                    <div class="mb-3" id="smoothingOptions">
                        <label for="smoothingMethod" class="form-label">Smoothing Method</label>
                        <select class="form-select" id="smoothingMethod">
                            <option value="combined">Combined (Kalman + Savitzky-Golay)</option>
                            <option value="kalman">Kalman Filter</option>
                            <option value="savgol">Savitzky-Golay</option>
                        </select>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="mb-3">
                        <label class="form-label">Export Formats</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportJson" checked>
                            <label class="form-check-label" for="exportJson">JSON</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportCsv">
                            <label class="form-check-label" for="exportCsv">CSV</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportBlender">
                            <label class="form-check-label" for="exportBlender">Blender Compatible</label>
                        </div>
                    </div>
                    
                    <!-- Video Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createOverlayVideo" checked>
                            <label class="form-check-label" for="createOverlayVideo">
                                Create Overlay Video
                            </label>
                        </div>
                        <div class="form-text">Generate video with pose visualization</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success" id="processBtn" disabled>
                            <i class="fas fa-play me-2"></i>
                            Start Processing
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Processing Results
                </h5>
            </div>
            <div class="card-body">
                <!-- Processing Status -->
                <div id="processingStatus" class="mb-4">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" id="processingSpinner"></div>
                        <span id="statusText">Processing...</span>
                    </div>
                    <div class="progress mt-2">
                        <div id="processingProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div id="resultsSummary" style="display: none;">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary" id="framesProcessed">0</h4>
                                <small class="text-muted">Frames Processed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success" id="avgConfidence">0%</h4>
                                <small class="text-muted">Avg. Confidence</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info" id="videoDuration">0s</h4>
                                <small class="text-muted">Duration</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning" id="outputFiles">0</h4>
                                <small class="text-muted">Output Files</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Download Links -->
                <div id="downloadSection" class="mt-4" style="display: none;">
                    <h6>Download Results:</h6>
                    <div class="row" id="downloadLinks">
                        <!-- Download buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Section -->
<div id="previewSection" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-eye me-2"></i>
                    Pose Data Preview
                </h5>
            </div>
            <div class="card-body">
                <div id="previewContent">
                    <!-- Preview visualization will be added here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let currentSessionId = null;
let processingInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateSmoothingOptions();
});

function initializeEventListeners() {
    // Upload form
    document.getElementById('uploadForm').addEventListener('submit', handleUpload);
    
    // Processing form
    document.getElementById('processingForm').addEventListener('submit', handleProcessing);
    
    // Smoothing checkbox
    document.getElementById('applySmoothing').addEventListener('change', updateSmoothingOptions);
}

function updateSmoothingOptions() {
    const smoothingEnabled = document.getElementById('applySmoothing').checked;
    document.getElementById('smoothingOptions').style.display = smoothingEnabled ? 'block' : 'none';
}

async function handleUpload(event) {
    event.preventDefault();
    
    const formData = new FormData();
    const videoFile = document.getElementById('videoFile').files[0];
    
    if (!videoFile) {
        showAlert('Please select a video file', 'danger');
        return;
    }
    
    formData.append('video', videoFile);
    
    // Show upload progress
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadBtn').disabled = true;
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            currentSessionId = result.session_id;
            showVideoInfo(result.video_info);
            document.getElementById('processBtn').disabled = false;
            showAlert('Video uploaded successfully!', 'success');
        } else {
            showAlert(result.error || 'Upload failed', 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error.message, 'danger');
    } finally {
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadBtn').disabled = false;
    }
}

async function handleProcessing(event) {
    event.preventDefault();
    
    if (!currentSessionId) {
        showAlert('Please upload a video first', 'warning');
        return;
    }
    
    // Collect processing options
    const options = {
        apply_smoothing: document.getElementById('applySmoothing').checked,
        smoothing_method: document.getElementById('smoothingMethod').value,
        create_overlay_video: document.getElementById('createOverlayVideo').checked,
        export_formats: []
    };
    
    if (document.getElementById('exportJson').checked) options.export_formats.push('json');
    if (document.getElementById('exportCsv').checked) options.export_formats.push('csv');
    if (document.getElementById('exportBlender').checked) options.export_formats.push('blender');
    
    // Show results section and start processing
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('processBtn').disabled = true;
    
    try {
        const response = await fetch(`/process/${currentSessionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(options)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Start polling for status
            startStatusPolling();
        } else {
            showAlert(result.error || 'Processing failed', 'danger');
            document.getElementById('processBtn').disabled = false;
        }
    } catch (error) {
        showAlert('Processing failed: ' + error.message, 'danger');
        document.getElementById('processBtn').disabled = false;
    }
}

function startStatusPolling() {
    processingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${currentSessionId}`);
            const status = await response.json();
            
            updateProcessingStatus(status);
            
            if (status.status === 'completed') {
                clearInterval(processingInterval);
                showResults(status);
                loadPreview();
            } else if (status.status === 'failed') {
                clearInterval(processingInterval);
                showAlert('Processing failed', 'danger');
                document.getElementById('processBtn').disabled = false;
            }
        } catch (error) {
            console.error('Status polling error:', error);
        }
    }, 2000);
}

function updateProcessingStatus(status) {
    const statusText = document.getElementById('statusText');
    const spinner = document.getElementById('processingSpinner');
    
    switch (status.status) {
        case 'processing':
            statusText.textContent = 'Processing video...';
            spinner.style.display = 'inline-block';
            break;
        case 'completed':
            statusText.textContent = 'Processing completed!';
            spinner.style.display = 'none';
            break;
        case 'failed':
            statusText.textContent = 'Processing failed';
            spinner.style.display = 'none';
            break;
    }
}

function showResults(status) {
    document.getElementById('resultsSummary').style.display = 'block';
    
    if (status.pose_stats) {
        document.getElementById('framesProcessed').textContent = status.pose_stats.total_frames;
        document.getElementById('avgConfidence').textContent = Math.round(status.pose_stats.avg_confidence * 100) + '%';
        document.getElementById('videoDuration').textContent = Math.round(status.pose_stats.duration) + 's';
    }
    
    document.getElementById('outputFiles').textContent = status.output_files.length;
    
    // Create download buttons
    const downloadLinks = document.getElementById('downloadLinks');
    downloadLinks.innerHTML = '';
    
    status.output_files.forEach(fileType => {
        const col = document.createElement('div');
        col.className = 'col-md-3 mb-2';
        
        const button = document.createElement('a');
        button.href = `/download/${currentSessionId}/${fileType}`;
        button.className = 'btn btn-outline-primary btn-sm w-100';
        button.innerHTML = `<i class="fas fa-download me-1"></i>${getFileTypeLabel(fileType)}`;
        
        col.appendChild(button);
        downloadLinks.appendChild(col);
    });
    
    document.getElementById('downloadSection').style.display = 'block';
}

async function loadPreview() {
    try {
        const response = await fetch(`/preview/${currentSessionId}`);
        const preview = await response.json();
        
        if (response.ok) {
            document.getElementById('previewSection').style.display = 'block';
            renderPreview(preview);
        }
    } catch (error) {
        console.error('Preview loading error:', error);
    }
}

function renderPreview(preview) {
    const content = document.getElementById('previewContent');
    content.innerHTML = `
        <p>Preview showing ${preview.preview_data.length} sample frames from ${preview.total_frames} total frames.</p>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Full pose visualization available in the downloaded overlay video.
        </div>
    `;
}

function showVideoInfo(videoInfo) {
    const infoCard = document.getElementById('videoInfoCard');
    const infoContent = document.getElementById('videoInfo');
    
    infoContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>Resolution:</strong> ${videoInfo.width} x ${videoInfo.height}<br>
                <strong>Frame Rate:</strong> ${videoInfo.fps.toFixed(2)} FPS<br>
            </div>
            <div class="col-md-6">
                <strong>Duration:</strong> ${Math.round(videoInfo.duration)}s<br>
                <strong>Total Frames:</strong> ${videoInfo.frame_count}<br>
            </div>
        </div>
    `;
    
    infoCard.style.display = 'block';
}

function getFileTypeLabel(fileType) {
    const labels = {
        'json': 'JSON Data',
        'csv': 'CSV Data',
        'blender': 'Blender Data',
        'overlay_video': 'Overlay Video',
        'statistics': 'Statistics'
    };
    return labels[fileType] || fileType.toUpperCase();
}

function showAlert(message, type) {
    const alertArea = document.getElementById('alertArea');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    alertArea.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function showHelp() {
    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    helpModal.show();
}
</script>
{% endblock %}